
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>SUSE Studio: Запускаем Linux в браузере - Hrafn.me</title>
  <meta name="author" content="Alexander 'Hrafn' Ivanov">

  
  <meta name="description" content="Продолжим переводить статьи Нэта Фридмана про SUSE Studio. На этот раз это
вторая из серии статей, которые он пишет о SUSE Studio и программных &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hrafn.me/2009/08/suse-studio-zapuskaem-linux-v-brauzere">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/hrafnme" rel="alternate" title="Hrafn.me" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Piwik --> 
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://stat.alexfinn.eu/" : "http://stat.alexfinn.eu/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 3);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://stat.alexfinn.eu/piwik.php?idsite=3" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft"></div>
  	<div id="logoText"></div>
  	<div id="logoRight"></div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Hrafn.me</a></h1>
  
    <h2>...</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/hrafnme" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hrafn.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="/docs">Docs</a></li>
  <li><a href="/lpi">LPI</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">SUSE Studio: Запускаем Linux в браузере</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2009-08-24T17:43:49+04:00" pubdate data-updated="true">Aug 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Продолжим переводить статьи Нэта Фридмана про SUSE Studio. На этот раз это
вторая из серии статей, которые он пишет о SUSE Studio и программных решениях.</p>

<p>Кстати, сегодня мне вдруг подумалось, что термин &#8220;программное решение&#8221; может
быть не совсем адекватным, но замену ему я придумать пока не смог. Можно было
бы написать &#8220;софтверное решение&#8221; или &#8220;программный комплекс&#8221;, но первый
вариант, на мой взгляд, несколько жаргонным выглядит, второй получше, но, как
мне кажется, ассоциируется не с тем, что имеется ввиду. В общем, если будут
пожелания на тему терминологии - милости прошу в комменты.</p>

<!--more-->


<p>Итак, начнем. <a href="http://nat.org/blog/2009/07/linux-in-the-browser/">Оригинал статьи</a>.</p>

<p>Многие люди поражаются, увидев, что их операционная система загружается в веб-
браузере. Но для SUSE Studio - это важная деталь удобства пользователя. В этом
сообщении я собираюсь поговорить о моей любимой возможности в SUSE Studio:
Testdrive. Почему мы создали это и как это все работает?</p>

<p><a href="/media/images/2009/08/24/susestudio/testdrive.png"><img src="/media/images/2009/08/24/susestudio/testdrive.png" alt="" /></a></p>

<p>SUSE Studio - это веб-сервис, который позволяет до смешного просто для любого
человека с веб-браузером и парой лет опыта работы в Linux создать программное
решение или свой собственный дистрибутив Linux менее чем за 10 минут.</p>

<p>Одной из основных задач при создании SUSE Studio было предоставление
пользователю ускоренного цикла &#8220;сборка-тестирование-настройка-пересборка&#8221;, что
бы он мог создавать и улучшать программные решения в несколько шагов.</p>

<p>Но мы также хотели, чтобы SUSE Studio имела как можно более низкий порог
вхождения. Если вы приходилось устанавливать какую-либо новую программу для
использования Studio, или, если бы  было необходимо иметь SUSE установленной
на компьютере, думаем, что гораздо меньше людей решили бы попробовать Studio.</p>

<p>Таким образом, это объясняет, почему мы сделали SUSE Studio веб-сервисом,
который можно использовать с любого компьютера, даже если у вас нет SUSE. И
даже если у вас вообще нет Linux. (Не смотря на то, что для использования SUSE
Studio желательно иметь некоторый опыт).</p>

<p>Но тут возникает другая проблема: если Studio - веб-сервис, то решение,
которое вы создаете, находится на наших серверах, а не на вашем компьютере.
Потому, для проверки созданного вам пришлось бы загрузить его, а потом
загрузить на виртуальной машине или записать на диск. Это ужасно замедлило бы
повторную разработку и сделало ее неудобной в использовании.</p>

<p><strong>Введение в Testdrive</strong></p>

<p>Мы решили эту проблему, сделав возможной загрузку вашего решения в веб-
браузере, быстро, в один клик. Мы называем эту возможность &#8220;testdrive&#8221;. Я
сделал короткий, всего 1 минута, скринкаст testdrive, в чем вы можете
убедиться сами.</p>

<p>Таким образом, вы можете наблюдать загрузку решения, вход в систему, запись
данных и запустить свою проверку, дабы убедиться, что все работает - без
необходимости скачивать что-либо. Если вы найдете проблему, то сможете
исправить ее, пересобрать образ и снова запустить проверку.</p>

<p><strong>Java vs Flash и VNC</strong></p>

<p>Работает все это таким образом - мы загружаем наше готовое решение в копию KVM
на нашем сервере и открываем доступ к фреймбуферу виртуальной машины через
VNC, подключаясь при помощи Flash-апплета в браузере.</p>

<p>Первая версия Testdrive использовала Java-апплет, но с ним было много проблем.
Апплет, реализованный посредством моста с Javascript, а также поведение центра
окна сильно различалось в различных версиях Java, которые работали у наших
пользователей. Иногда пользователи не могли вообще печатать в Java. Иногда они
видели только серый прямоугольник. По этим причинам мы решили перейти на
Flash, который работал намного лучше.</p>

<p>Мы также поигрались с протоколом VNC, чтобы проверить, возможно ли у него
улучшить производительность. Существуют некоторые расширения VNC для сжатия
траффика фреймбуфера с помощью группового кодирования и сжатия JPEG, но мы
подумали, что можно было бы сделать еще лучше.</p>

<p>Мы добавили сжатие клеток PNG, посчитав, что это будет выглядеть лучше, чем
JPEG. Использование PNG также позволило нам вернуться к разнообразию серых
оттенков или к монохромному отображению на медленных соединениях. Мы также
добавили к клиенту и серверу кэш клеток дабы избежать их избыточной передачи.
И я работал на патчем для автоматического обнаружения скроллинга консоли, в
следствие чего, мы смогли использовать CopyRec, чтобы избежать полной
перерисовки экрана.</p>

<p>Мы тестировали это в течение нескольких месяцев, но в конечном итоге, эти
расширения не возымели того действия, на которое мы рассчитывали. И, с учетом
того, что они не стандартизированы, было тяжело поддерживать их и они
требовали множества хаков. В конце концов, мы выкинули все это и сейчас
используем более стандартные расширения VNC (ZRLE и Tight).</p>

<p>Хотя мы не прекратили использование это кода, это был хороший эксперимент. А
также - это хороший пример нашей работы в команде: смелость пробовать что-то
новое для улучшения удобства пользователей.</p>

<p><strong>Измененные файлы</strong></p>

<p>Очень полезно иметь интегрированный механизм тестирования, но мы также хотели
сделать возможным тонкую настройку вашего решения изнутри Testdrive при помощи
запуска команд, редактирования файлов или установки нового программного
обеспечения.</p>

<p>Например, вы можете захотеть настроить рабочий стол, добавить иконку запуска
программы, изменить размер или множество других мелких деталей, которые проще
делать интерактивно, чем выискивая нужную команду или файл для изменения. Или
у вашего приложения может быть интерактивный установщик, который вы хотите
запустить таким образом, чтобы у пользователей его не было.</p>

<p>Когда система Linux загружается первый раз, она создает и изменяет множество
файлов, которые вы точно не хотите включать в решение, предоставляемое
пользователям: такие вещи, как ключи SSH, resolv.conf и т.д. Чтобы этого не
происходило - включите режим &#8220;только для чтения&#8221; в сессии Testdrive.</p>

<p>(Если вы читаете это через RSS и не видите скринкаста, <a href="http://nat.org/blog/2009/07/suse-studio-testdrive/">кликните здесь</a>).</p>

<p><strong>Как работают измененные файлы</strong></p>

<p>Есть несколько возможностей выяснить это.</p>

<p>Нам требовалось решение, которому бы не требованлось взаимодействие с самим
приложением. Отдельный модуль ядра или любой другой хак, добавленный в
приложение, ограничил бы диапазон пользователей, который могли бы работать с
SUSE Studio. Мы хотели, чтобы наши пользователи могли выбрать любое ядро, к
примеру.</p>

<p>Нам также было необходимо сделать возможным динамическое создание списка
изменений файловых систем в течение 1-2 секунд. Что-то более медленное делало
бы не удобным интерактивное использование.</p>

<p>Я потратил неделю, проверяя различные способы и каждый раз упирался в
препятствия. Большая часть из опробованного была слишком медленной.</p>

<p>Затем, как-то поздно ночью, во время телефонного разговора с
<a href="http://tirania.org/">Мигелем</a>, мы натолкнулись на действительно великолепное
решение.</p>

<p>QEMU (с помощью расширения KVM) имеет возможность запускать виртуальную машину
с помощью образа диска с механизмом копирования при записи или cowfile.Каждый
раз, когда виртуальная машина хочет прочитать заблокированный диск, она
сначала проверяет, представлен ли этот блок в cowfile, и возвращается к
оригинальному образу приложения, если нет.</p>

<p>Таким образом, вы фактически имеет две копии образа диска - оригинальный образ
и измененный образ - без необходимости делать полную копию. Магия оператора
&#8220;if&#8221;.</p>

<p>Все это - обычная практика.</p>

<p>Необычность в том, что мы используем libext2fs, реализацию файловой системы
ext2fs в пространстве пользователя, для чтения метаданных как оригинальной,
так и модифицированной файловых систем. Мы считываем все inodes и dentries в
память, сравниваем их и показываем различия. И это отлично работает. Когда
diff запускается впервые, это занимает несколько секунд, но затем блоки
метаданных кэшируются, и можно увидеть свежие различия многогигабайтных
приложений менее чем за полсекунды.</p>

<p>После разговора с Мигелем мне потребовалось около двух дней, чтобы заставить
все это работать. Это был великолепный хак, один из лучших за последние годы.
Сделать это было довольно просто (как мы только что выяснили), но я никогда не
видел, чтобы какое-нибудь приложение по виртуализации предлагало подобное
ранее.</p>

<p>Между прочим, мы можем использовать ту же технику для поиска неиспользуемых
файлов и пакетов, которые пользователь может удалить из приложения для
уменьшения размера.</p>

<p>Это просто работает, если, конечно, вы запускали полноценный тест в Testdrive.</p>

<p><strong>Сеть</strong></p>

<p>Вы не можете создавать исходящие сетевые соединения во время тестовой сессии,
но мы предоставляем возможность создавать входящие соединения по некоторым
портам, чтобы вы могли использовать вход по SSH или тестировать веб-
приложения, запущенные на вашем решении. По причинам безопасности, вам
придется явно включить эту возможность, кликнув по кнопке , а входящие
соединения будут ограничены IP-адресом вашего браузера. Мы осуществили это
ограничение с помощью <a href="http://nat.org/studio/qemu-kvm-no-outgoing.patch.txt">простого патча для QEMU</a>, который<a href="http://alex.csgraf.de/self/"> Алекс Граф</a>
написал за 15 минут. (Алекс, кажется, все делает за 15 минут).</p>

<p><strong>Серверы</strong></p>

<p>Мы предоставляем каждому экземпляру Testdrive 512 MB оперативной памяти и час
на работу. Современный сервер за $2000 держит одновременно 16 экземпляров
Testdrive и имеет продолжительность жизни около 2 лет. Мы берем на себя 30%
потребления и использование электроэнергии, охлаждения и пропускной
способности, и оцениваем стоимость хостинга каждой сессии примерно в 6 центов.
Нам это кажется справедливой ценой за предоставление возможности разработчикам
создавать решения с помощью SUSE Linux.</p>

<p>Мы запускаем Testdrive на своей собственной серверной ферме, которую мы
обслуживаем самостоятельно, не в облачном сервисе вроде EC2. Мы думаем, что
EC2 - это действительно здорово, и фактически мы планируем добавить поддержку
вывода EC2 AMI в Studio в будущем. Но только это может не сработать для
какого-то специфического сервиса.</p>

<p>Стоимость - одна из причин. Мы можем управлять нашими серверами Testdrive,
неся гораздо меньшие расходы, чем издержки Amazon на сегодня. Является фактом
также то, что каждая сессия testdrive - самостоятельный эксземпляр виртуальной
машины, и для запуска ее в EC2 необходима поддержки вложенной виртуализации,
которая в данный момент не поддерживается в EC2. Хотя, Алекс Граф внедрил это
в KVM во <a href="http://avikivity.blogspot.com/2008/09/nested-svm-virtualization-for-kvm.html">вложенных патчах SVM</a>.</p>

<p><strong>О QEMU</strong></p>

<p>Краткое отступление, многие наши эксперимента с testdrive стали возможны из-за
того, что у нас был <a href="http://www.qemu.org/">QEMU</a> в качестве основы.
Первоначально написанный <a href="http://bellard.org/">Фабрисом Белларом</a> QEMU - одна
из любимейших открытых кодовых баз. Не только по причине его мощности и
возможностей - он эмулирует десятки устройств и ЦП в программном обеспечении -
а из-за того, что код прост и дружелюбен для хакеров. Это чистый и модульный
и этого очень не достает в запутывающем слое абстракций и универсальности и
проектно-специфического жаргона, который во многих больших программах
затрудняет работу. Хотя я - полный новичок в технологиях виртуализации, я
нашел, что могу понимать QEMU и писать основные патчи в пределах времени
распаковки дерева исходников (конечно, возможно, что более глубокие части, до
котолрых мне не добраться, гораздо более сложны для хаков). QEMU - основа и
для KVM, и для Xen HVM, и, по моему мнению, невоспетый герой opensource-виртуализации.</p>

<p><a href="http://bellard.org/">Фабрис Беллар</a>, доолжно быть, один из самых талантливых
и плодовитых разработчиков, работающих сегодня, и я определенно рекомендую
взглянуть на другие его проекты, включая <a href="http://www.ffmpeg.org/">ffmpeg</a>,
<a href="http://numcalc.com/">numcalc.com</a>,
<a href="http://fabrice.bellard.free.fr/TinyGL/">tinygl</a>, tinygcc и его алгоритмы для
вычисления числа Пи.</p>

<p><strong>Ok&#8230;</strong></p>

<p>Я надеюсь, что вы найдете этот пост интересным. Я буду рад любым отзывам, и я
хотел бы знать, что вы желаете услышать в дальнейших постах!</p>

<p><strong>Другие посты о SUSE Studio и программных приложениях:</strong></p>

<ul>
<li><a href="http://hrafn.me/2009/07/suse-studio-1-0/">SUSE Studio 1.0</a></li>
<li><a href="http://hrafn.me/2009/07/suse-studio-chto-takoe-programmnoe-reshenie/">What is a software appliance?</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">hrafn</span></span>

      








  


<time datetime="2009-08-24T17:43:49+04:00" pubdate data-updated="true">Aug 24<span>th</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://hrafn.me/2009/08/suse-studio-zapuskaem-linux-v-brauzere" data-via="" data-counturl="http://hrafn.me/2009/08/suse-studio-zapuskaem-linux-v-brauzere" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/2009/07/suse-studio-chto-takoe-programmnoe-reshenie" title="Previous Post: SUSE Studio. Что такое программное решение?">&laquo; SUSE Studio. Что такое программное решение?</a>
      
      
        <a class="basic-alignment right articlenav" href="/2009/08/vasha-os-mozhet-sdelat-eto" title="Next Post: SUSE Studio: Ваша ОС может сделать это?">SUSE Studio: Ваша ОС может сделать это? &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/04/chef-basics-search-and-databags">Основы Chef. Поиск и Data Bags</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-introduction-to-cookbooks">Основы Chef. Введение в "Поваренные книги"</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-core-components">Основы Chef. Базовые компоненты</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-architecture">Основы Chef. Введение в архитектуру</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/about-blog-design">Немного про дизайн</a>
      </li>
    
  </ul>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103291489173191931572?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Alexander 'Hrafn' Ivanov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
