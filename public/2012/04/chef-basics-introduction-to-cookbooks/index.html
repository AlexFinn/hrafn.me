
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Основы Chef. Введение в "Поваренные книги" - Hrafn.me</title>
  <meta name="author" content="Alexander 'Hrafn' Ivanov">

  
  <meta name="description" content="Ссылка на оригинал &#8220;Поваренные книги&#8221; - способ, которым пользователи Chef и Hosted Chef запаковывают, распространяют и делают общей &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hrafn.me/2012/04/chef-basics-introduction-to-cookbooks">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/hrafnme" rel="alternate" title="Hrafn.me" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <!-- Piwik --> 
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://stat.alexfinn.eu/" : "http://stat.alexfinn.eu/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 3);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://stat.alexfinn.eu/piwik.php?idsite=3" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft"></div>
  	<div id="logoText"></div>
  	<div id="logoRight"></div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Hrafn.me</a></h1>
  
    <h2>...</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/hrafnme" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hrafn.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="/docs">Docs</a></li>
  <li><a href="/lpi">LPI</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Основы Chef. Введение в "Поваренные книги"</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-04-22T00:00:00+04:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://wiki.opscode.com/display/chef/Introduction+to+Cookbooks+and+More">Ссылка на оригинал</a></p>

<p>&#8220;Поваренные книги&#8221; - способ, которым пользователи Chef и Hosted Chef запаковывают, распространяют и делают общей информацию о конфигурации. Они объединяют все ресурсы, необходимые для автоматизации инфраструктуры, а также облегчают обмен с другими пользователями Chef.</p>

<p>Они содержат рецепты, файлы аттрибутов, шаблоны и другие штуки для настройки.</p>

<!--more-->


<p>При запуске Chef-Client рецепты, перечисленные с списке запуска узла перенаправляются на узел наравне с другим содержимым &#8220;поваренной книги&#8221;, содержащей рецепт. Эти рецепты затем применяются к узлу, приводя его в надлежащее состояние.</p>

<p><a href="/media/images/2012/04/22/chef-basics-cookbook.png"><img src="/media/images/2012/04/22/chef-basics-cookbook.png" alt="" /></a></p>

<p>Обычно, единственная поваренная книга сожержит информацию, необходимую для настройки одного сервиса или одной части системы. Например, в ней может быть &#8220;поваренная книга&#8221; &#8220;users&#8221; для настройки пользователей, которые должны иметь доступ к системе и &#8220;поваренная книга&#8221; &#8220;apache&#8221; для настройки веб-сервера Apache.</p>

<p>&#8220;Поваренные&#8221; книги могут быть созданы любым человеком, обладающим начальными навыками программирования, и они могут быть написаны без сохранения каких-либо подробностей о развернутом окружении. Это означает, что их можно безопасно распространять и повторно использовать по всей территории организации и компании. Opscode поощряет публикацию пользователями своих &#8220;поваренных книг&#8221; на Opscode Community Site, где можно выбрать уже из более 300 &#8220;поваренных книг&#8221;. В результате, можно устанавливать и настраивать многие полезные вещи даже без написания новой &#8220;поваренной книги&#8221;.</p>

<p>Если репозиторий Chef использует git, можно быстро найти и использовать &#8220;поваренные книги&#8221;, написанные сообществом, используя инструмент командной строки - Knife. Например, для того, чтобы скачать простую &#8220;поваренную книгу&#8221; &#8220;getting-started&#8221;, можно запустить следующее из репозитория chef:</p>

<pre><code>    knife cookbook site install getting-started
</code></pre>

<p>Для выгрузки ее на Chef Server или Hosted Chef:</p>

<pre><code>    knife cookbook upload getting-started
</code></pre>

<p>И, для добавления рецепта &#8220;default&#8221; в эту поваренную книгу для списка запуска узла:</p>

<pre><code>    knife node run_list add my_node 'getting-started::default'
</code></pre>

<p>Chef также предоставляет инструменты для более легкого создания новой поваренной книги. Например, для создания базовой структуры новой поваренной книги в репозитории Chef, можно использовать knife:</p>

<pre><code>    knife cookbook create new_cookbook_name
</code></pre>

<h2>Рецепты</h2>

<p>Рецепты - это файлы Ruby, в которых используется Domain Specific Language (DSL) для определения того, каким образом конкретные части узла следует настраивать. Как можно будет увидеть в последующих секциях, можно использовать данные, совмещенные с возможностью использовать код ruby в рецептах для динамического изменения конфигурации узла.</p>

<p>&#8220;Поваренные книги&#8221; могут содержать множество рецептов, включая рецепты, добавленные в список запуска по их полному имени, используя форму COOKBOOK_NAME::RECIPE_NAME. В список запуска добавляются только роли и рецепты.</p>

<p>Chef, однако, предоставляет укороченную нотацию для имен рецептов и &#8220;поваренных книг&#8221; в команде списка запуска. (Это полезно для рецептов, которые используются в качестве основной конфигурации для набора узлов).</p>

<p>При добавлении COOKBOOK_NAME в список запуска Chef считает, что нужен рецепт с именем &#8220;default&#8221; из &#8220;поваренной книги&#8221; с тем же именем. Чтобы посмотреть на пример такого поведения, можно изменить команду knife, использованную выше, для добавления рецепта в список запуска узла. Успользуя укороченный вариант, можно просто дать команду, приведенную выше:</p>

<pre><code>    knife node run_list add my_node getting-started
</code></pre>

<p>Этом обновленном примере добавляется рецепт &#8220;default&#8221; из &#8220;поваренной книги&#8221; &#8220;getting-started&#8221; в список запуска &#8220;my_node&#8221;, как и прежде.</p>

<h2>Ресурсы и Провайдеры</h2>

<p>Ресурсы - это строительные блоки, которые будут использоваться для создания должным образом настроенного узла. Они представляют собой крос-платформенную абстракцию того, что настраивается на узле - отдельные куски конфигурации системы, которые помещены в рецепты и применяются к узлам.</p>

<p>Ключевой особенностью ресурсов является то, что они позволяют сфокусироваться на описании конфигурации узла вместо того, чтобы указывать, каким образом конкретная задача должна быть выполнена.</p>

<p>Например, следующий ресурс добавляет пользователя на узел:</p>

<pre><code>    user "sam" do
      home "/home/sam"
      shell "bin/zsh"
      comment "Sam loves DevOps"
      action :create
    end
</code></pre>

<p>Этот ресурс описывает пользователя, &#8220;sam&#8221;, которого необходимо создать на узле. В действительности создание производится Провайдером, который выполняет команды, необходимые для создания нового пользователя.</p>

<p>Отдельные ресурсы могут иметь множество провайдеров, каждый из которых знает, как выполнить необходимые задачи на различных платформах. Chef-client выберет лучшего провайдера для платформы узла. Таким образом, описание этого едиснтвенного ресурса можеь быть использовано для создания пользователя &#8220;sam&#8221; на Linux-системе и FreeBSD-системе, без каких-либо изменений.</p>

<p>Ресурс пользователя, описанный выше, структурирован так же, как все описания ресурсов в Chef Domain Specific Language (DSL):</p>

<pre><code>    resource_type "resource_name" do
      resource_attribute value
      ...
    end
</code></pre>

<p>Тип ресурса относится к виду ресурса, который необходимо настроить. Многие различные ресурсы определяются при помощи Chef DSL. Полный список этих ресурсов можно найти на странице <a href="http://wiki.opscode.com/display/chef/Resources">Ресурсы</a>. Обладая глубокими знаниями Chef, можно даже расширить Chef DSL с помощью собственных ресурсов.</p>

<p>Имя ресурса - это строка, идентифицирующая этот специфичный экзмепляр ресурса. Для конфигурации конкретного узла может потребоваться определение множества ресурсов пользователей, каждый из которых будет иметь свое собственное имя и может быть направлен к другому ресурсу. Имя ресурса, также, по умолчанию, используется как значение для одного из &#8220;аттрибутов ресурса&#8221;. Например, в ресурсе пользователя, описанном выше, имя &#8220;sam&#8221; будет использоваться в качестве имени пользователя для пользователя, которого создаст chef-client.</p>

<p>Аттрибуты ресурса и относящиеся к ним значения описвают желаемое состояние ресурса. Каждый ресурс обладает различными аттрибутами, важными в контексте данного ресурса. Аттрибут &#8220;action&#8221; - это аттрибут, использующийся всеми ресурсами и определяющий, что должно произойти с этим ресурсом. В примере выше, действие &#8220;create&#8221; указывает, что требуется создать пользователя. Когда sam покинет организацию, можно изменить это действие на &#8220;:delete&#8221; для удаления пользователя.</p>

<p>Доступные аттрибуты ресурса и их значения по умолчанию подробно описываются на странице <a href="http://wiki.opscode.com/display/chef/Resources">Ресурсы</a>.</p>

<p>Когда chef-client загружает рецепты с свой список запуска.</p>

<ol>
<li>он запускает каждый рецепт как часть кода ruby</li>
<li>каждый раз, когда ресурс используется, он добавляетя в коллекцию ресурсов для этого узла</li>
<li>затем провайдеры этих ресурсов принимают решение действовать или нет для выполнения описания ресурсов.</li>
</ol>


<p>Таким образом, ключевым принципом Chef является достижение: идемпотентность. Идемпотентность позволяет убедиться, что ресурс может применяться к машине множество раз и всегда будет получен тот же самый результат: должным образом настроенная машина.</p>

<h2>Аттрибуты и Шаблоны</h2>

<p>Аттрибуты обеспечивают хранение вложенных пар ключ-значение данных об узле и его конфигурации. Некоторые аттрибуты автоматически собираются на старте каждого запуска chef-client и включают такую информацию, как IP-адрес узлов, имя хоста или загруженные модули ядра. Другие аттрибуты добавляются из других источников, например, &#8220;поваренные книги&#8221;. (Роли и Окружения также могут устанавливать аттрибуты, об этом будет написано далее).</p>

<p>Аттрибуты позволяют изменить конфигурацию на основе характеристик узла и установить разумные значения по умолчанию для конфигурации сервиса, что также позволяет легко их изменять. Единственный способ установить аттрибуты - файлы аттрибутов в &#8220;поваренной книге&#8221;.</p>

<p>Например, далее устанавливаются некоторые разумные значения по умолчанию для расположения определенного конфигурационного файла:</p>

<pre><code>    default["my_application"]["config_location"] = "/etc/myapp.conf"
</code></pre>

<p>Затем этот аттрибут может использоваться напрямую при контроле ресурсов конфигурационного файла:</p>

<pre><code>    template node["my_application"]["config_location"] do
      action :create
    end
</code></pre>

<p>Определение Шаблона, который является особенностью Chef, позволяет создавать общие файлы, содержание которых может быть сгенерировано автоматически. Если этот файл конфигурации много раз упоминался в рецепте, изменение его расположения - причина изменения одного аттрибута.</p>

<p>Аттрибуты узла также содержат игформацию об узле, которая может использоваться в рецепте:</p>

<pre><code>    if node.attribute?("ec2")
      # Выполнить специфичные для EC2 задачи.
    end
</code></pre>

<p>Это позволит рецепту выполнить некий набор задач по настройке только в том случае, если он был запущен в облаке Amazon EC2. За полной информацией об Аттрибутах необходимо обратиться к <a href="http://wiki.opscode.com/display/chef/Attributes">следующей странице</a>.</p>

<h2>Роли</h2>

<p>Настройка одного узла может потребовать множество различных &#8220;поваренных книг&#8221;. Для упорядочивания в группы похожих возможностей на похожих хостах Chef предоставляет Роли. Роли содержат список запуска (только для узла) и аттрибуты, относящиеся к конкретной функции. Например, можно создать роль &#8220;webserver&#8221;, которяа будет включать список запуска со всеми сервисами, необходимыми для работы типичного веб-сервера в пределах инфраструктуры. Список запуска узла может содержать эти роли.</p>

<p>В случае, если в списке запуска узла находится роль, список запуска самой роли расширяется и добавляется к списку запуска узла, чтобы быть уверенным, что все рецепты для указанной роли применены к узлу.</p>

<p>Роли также могут устанавливать аттрибуты. Установка аттрибутов в ролях позволяет переназначить аттрибуты по умолчанию общей &#8220;поваренной&#8221; книги на значения, более соответствующие узлу с указанной ролью.</p>

<p><a href="/media/images/2012-04/22/chef-basics-roles.png"><img src="/media/images/2012/04/22/chef-basics-roles.png" alt="" /></a></p>

<h2>Окружения</h2>

<p>Окружения в Chef предоставляют механизм для управления такими разлиными окружениями, как production, staging, development и testing в пределах одного Chef Server или организации Hosted Chef. С помощью окружений можно указать &#8220;список запуска&#8221; в роли, ограничение по версии &#8220;поваренной книги&#8221; и аттрибуты окружения для каждого их них по отдельности. Роли отличаются в это плане тем, что группируют системы по определенным функциям и могут распространяться между окружениями - например: сервер приложений, веб-сервер, сервер баз данных. Таким образом, есть возможность иметь список запуска для каждого окружения внутри роли - например: в окружении development сервер приложений должен подключаться к другому балансировщику нагрузки, находящимся в окружении test, и этим можно управлять внутри одного рецепта.</p>

<p>Можно создавать и управлять окружениями множеством способов, адаптируя их для удовлетворения сосбтвенных нужд и нужд инфраструктуры. Обратитесь к странице <a href="http://wiki.opscode.com/display/chef/Environments">Окружения</a> для получения подробностей.</p>

<h2>Кратко об описанном</h2>

<ul>
<li>Поваренные книги содержат рецепты, файлы аттрибутов и других информацию о конфигурации</li>
<li>Ресурсы представляют собой строительные блоки для рецептов и описывают конкретную часть конфигурации узла</li>
<li>Ресурсы идемпотентны. Применение одного и того же ресурса дважды должно приводить к одному и тому же результату</li>
<li>Провайдеры применяют необходимые действия, требующиеся для приведения узла в состояние согласно описанию ресурса</li>
<li>Аттрибуты предоставляет настраиваемые параметры, которые могут использоваться в рецептах, так же как информация об узле</li>
<li>Роли предоставляют способ описания определенной функции или типа узла. Роли имеют списки запуска и аттрибуты.</li>
<li>Окружения предоставляют способ управления различными инфраструктурными пространствами в пределах одного экземпляра Chef.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alexander 'Hrafn' Ivanov</span></span>

      








  


<time datetime="2012-04-22T00:00:00+04:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://hrafn.me/2012/04/chef-basics-introduction-to-cookbooks" data-via="" data-counturl="http://hrafn.me/2012/04/chef-basics-introduction-to-cookbooks" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/2012/04/chef-basics-core-components" title="Previous Post: Основы Chef. Базовые компоненты">&laquo; Основы Chef. Базовые компоненты</a>
      
      
        <a class="basic-alignment right articlenav" href="/2012/04/chef-basics-search-and-databags" title="Next Post: Основы Chef. Поиск и Data Bags">Основы Chef. Поиск и Data Bags &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/04/chef-basics-search-and-databags">Основы Chef. Поиск и Data Bags</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-introduction-to-cookbooks">Основы Chef. Введение в "Поваренные книги"</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-core-components">Основы Chef. Базовые компоненты</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/chef-basics-architecture">Основы Chef. Введение в архитектуру</a>
      </li>
    
      <li class="post">
        <a href="/2012/04/about-blog-design">Немного про дизайн</a>
      </li>
    
  </ul>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103291489173191931572?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Alexander 'Hrafn' Ivanov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
